# 小胰宝智能助手平台 - 用户认证系统说明

## 概述

本系统已集成完整的用户认证和权限管理功能，使用MongoDB作为底层数据库，JWT作为认证令牌。

## 功能特性

### 🔐 用户认证
- 用户注册和登录
- JWT令牌认证
- 密码加密存储（bcrypt）
- 会话管理

### 👥 用户管理
- 多角色支持（管理员、高级用户、普通用户）
- 用户状态管理（活跃、非活跃、暂停）
- 用户信息CRUD操作
- API调用次数统计和限制

### 🛡️ 权限控制
- 基于角色的访问控制（RBAC）
- API端点权限保护
- 管理员专用功能

## 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用      │    │   FastAPI       │    │   MongoDB       │
│                │◄──►│   后端服务      │◄──►│   数据库        │
│                │    │                │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   JWT认证       │
                       │   中间件        │
                       └─────────────────┘
```

## 安装和配置

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置环境变量

复制 `config.env.template` 为 `.env` 并配置：

```bash
cp config.env.template .env
```

编辑 `.env` 文件：

```env
# MongoDB配置
MONGO_URI=mongodb://localhost:27017
MONGO_DATABASE=pancrepal

# JWT配置
JWT_SECRET_KEY=your-super-secret-jwt-key-here
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30

# 其他配置...
```

### 3. 启动MongoDB

确保MongoDB服务正在运行：

```bash
# macOS (使用Homebrew)
brew services start mongodb-community

# Ubuntu/Debian
sudo systemctl start mongod

# Windows
net start MongoDB
```

### 4. 创建管理员用户

运行初始化脚本：

```bash
python scripts/create_admin.py
```

这将创建：
- 管理员账户：`admin` / `admin123456`
- 演示用户：`demo_user` / `demo123456`
- 高级用户：`premium_user` / `premium123456`

## API使用说明

### 用户注册

```bash
curl -X POST "http://localhost:8000/api/v1/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "email": "user@example.com",
    "full_name": "新用户",
    "password": "password123"
  }'
```

### 用户登录

```bash
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123456"
  }'
```

响应示例：
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "token_type": "bearer",
  "expires_in": 1800,
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "username": "admin",
    "email": "admin@pancrepal.com",
    "role": "admin",
    "status": "active"
  }
}
```

### 使用认证令牌

```bash
curl -X GET "http://localhost:8000/api/v1/auth/me" \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
```

## 权限级别

### 🔓 公开端点
- `POST /api/v1/auth/register` - 用户注册
- `POST /api/v1/auth/login` - 用户登录
- `GET /health` - 健康检查

### 🔐 需要认证的端点
- `GET /api/v1/auth/me` - 获取当前用户信息
- `PUT /api/v1/auth/me` - 更新当前用户信息
- `POST /api/v1/auth/change-password` - 修改密码

### 👑 管理员专用端点
- `GET /api/v1/auth/users` - 获取用户列表
- `GET /api/v1/auth/users/{user_id}` - 获取指定用户信息
- `PUT /api/v1/auth/users/{user_id}` - 更新指定用户信息
- `DELETE /api/v1/auth/users/{user_id}` - 删除指定用户
- `GET /api/v1/auth/stats` - 获取用户统计信息

## 数据库结构

### 用户集合 (users)

```json
{
  "_id": "ObjectId",
  "username": "string (唯一)",
  "email": "string (唯一)",
  "full_name": "string",
  "role": "admin|premium|user",
  "status": "active|inactive|suspended",
  "hashed_password": "string",
  "created_at": "datetime",
  "updated_at": "datetime",
  "last_login": "datetime",
  "api_calls_count": "number",
  "max_api_calls": "number"
}
```

### 索引
- `username` - 唯一索引
- `email` - 唯一索引
- `role` - 普通索引
- `status` - 普通索引
- `created_at` - 普通索引

## 安全特性

### 🔒 密码安全
- 使用bcrypt进行密码哈希
- 密码强度验证（最少6位）
- 支持密码修改

### 🎫 JWT安全
- 令牌过期时间：30分钟
- 使用HS256算法
- 包含用户角色信息

### 🛡️ 访问控制
- 基于角色的权限控制
- API调用次数限制
- 用户状态验证

## 开发指南

### 添加认证到现有API

```python
from auth.dependencies import get_current_active_user, get_admin_user

@app.get("/protected-endpoint")
async def protected_endpoint(current_user = Depends(get_current_active_user)):
    return {"message": f"Hello {current_user.username}!"}

@app.get("/admin-only")
async def admin_endpoint(current_user = Depends(get_admin_user)):
    return {"message": "Admin only!"}
```

### 检查API限制

```python
from auth.dependencies import check_api_limit, increment_api_calls

@app.post("/api-call")
async def api_call(current_user = Depends(get_current_active_user)):
    # 检查API调用限制
    if not check_api_limit(current_user.id):
        raise HTTPException(status_code=429, detail="API调用次数超限")
    
    # 增加API调用次数
    await increment_api_calls(current_user.id)
    
    # 执行业务逻辑
    return {"message": "API调用成功"}
```

## 故障排除

### 常见问题

1. **MongoDB连接失败**
   - 检查MongoDB服务是否运行
   - 验证连接字符串格式
   - 检查网络连接

2. **JWT令牌无效**
   - 检查令牌是否过期
   - 验证令牌格式
   - 确认SECRET_KEY配置

3. **权限不足**
   - 检查用户角色
   - 验证用户状态
   - 确认API端点权限要求

### 日志查看

系统会记录详细的日志信息，包括：
- 用户认证过程
- 数据库操作
- 错误和异常
- API调用统计

## 生产环境部署

### 安全建议

1. **更改默认密码**
   - 首次部署后立即修改管理员密码
   - 使用强密码策略

2. **JWT密钥管理**
   - 使用强随机密钥
   - 定期轮换密钥
   - 通过环境变量管理

3. **网络安全**
   - 限制CORS来源
   - 使用HTTPS
   - 配置防火墙规则

4. **数据库安全**
   - 启用MongoDB认证
   - 限制数据库访问IP
   - 定期备份数据

### 性能优化

1. **数据库优化**
   - 创建适当的索引
   - 监控查询性能
   - 定期清理过期数据

2. **缓存策略**
   - 实现Redis缓存
   - 缓存用户会话信息
   - 缓存频繁查询结果

## 更新日志

### v0.2.0 (当前版本)
- ✅ 集成用户认证系统
- ✅ MongoDB数据库支持
- ✅ JWT令牌认证
- ✅ 基于角色的权限控制
- ✅ 用户管理API
- ✅ API调用限制

### v0.1.0
- ✅ 基础智能体系统
- ✅ 多AI平台支持

## 技术支持

如有问题或建议，请：
1. 查看系统日志
2. 检查API文档
3. 提交Issue到项目仓库

---

**注意**: 本系统仅供学习和研究使用，生产环境部署请遵循安全最佳实践。
