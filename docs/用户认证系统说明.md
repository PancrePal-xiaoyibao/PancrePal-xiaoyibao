# å°èƒ°å®æ™ºèƒ½åŠ©æ‰‹å¹³å° - ç”¨æˆ·è®¤è¯ç³»ç»Ÿè¯´æ˜

## æ¦‚è¿°

æœ¬ç³»ç»Ÿå·²é›†æˆå®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†åŠŸèƒ½ï¼Œä½¿ç”¨MongoDBä½œä¸ºåº•å±‚æ•°æ®åº“ï¼ŒJWTä½œä¸ºè®¤è¯ä»¤ç‰Œã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ” ç”¨æˆ·è®¤è¯
- ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
- JWTä»¤ç‰Œè®¤è¯
- å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆbcryptï¼‰
- ä¼šè¯ç®¡ç†

### ğŸ‘¥ ç”¨æˆ·ç®¡ç†
- å¤šè§’è‰²æ”¯æŒï¼ˆç®¡ç†å‘˜ã€é«˜çº§ç”¨æˆ·ã€æ™®é€šç”¨æˆ·ï¼‰
- ç”¨æˆ·çŠ¶æ€ç®¡ç†ï¼ˆæ´»è·ƒã€éæ´»è·ƒã€æš‚åœï¼‰
- ç”¨æˆ·ä¿¡æ¯CRUDæ“ä½œ
- APIè°ƒç”¨æ¬¡æ•°ç»Ÿè®¡å’Œé™åˆ¶

### ğŸ›¡ï¸ æƒé™æ§åˆ¶
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- APIç«¯ç‚¹æƒé™ä¿æŠ¤
- ç®¡ç†å‘˜ä¸“ç”¨åŠŸèƒ½

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯åº”ç”¨      â”‚    â”‚   FastAPI       â”‚    â”‚   MongoDB       â”‚
â”‚                â”‚â—„â”€â”€â–ºâ”‚   åç«¯æœåŠ¡      â”‚â—„â”€â”€â–ºâ”‚   æ•°æ®åº“        â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   JWTè®¤è¯       â”‚
                       â”‚   ä¸­é—´ä»¶        â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å®‰è£…å’Œé…ç½®

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `config.env.template` ä¸º `.env` å¹¶é…ç½®ï¼š

```bash
cp config.env.template .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
# MongoDBé…ç½®
MONGO_URI=mongodb://localhost:27017
MONGO_DATABASE=pancrepal

# JWTé…ç½®
JWT_SECRET_KEY=your-super-secret-jwt-key-here
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30

# å…¶ä»–é…ç½®...
```

### 3. å¯åŠ¨MongoDB

ç¡®ä¿MongoDBæœåŠ¡æ­£åœ¨è¿è¡Œï¼š

```bash
# macOS (ä½¿ç”¨Homebrew)
brew services start mongodb-community

# Ubuntu/Debian
sudo systemctl start mongod

# Windows
net start MongoDB
```

### 4. åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·

è¿è¡Œåˆå§‹åŒ–è„šæœ¬ï¼š

```bash
python scripts/create_admin.py
```

è¿™å°†åˆ›å»ºï¼š
- ç®¡ç†å‘˜è´¦æˆ·ï¼š`admin` / `admin123456`
- æ¼”ç¤ºç”¨æˆ·ï¼š`demo_user` / `demo123456`
- é«˜çº§ç”¨æˆ·ï¼š`premium_user` / `premium123456`

## APIä½¿ç”¨è¯´æ˜

### ç”¨æˆ·æ³¨å†Œ

```bash
curl -X POST "http://localhost:8000/api/v1/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "email": "user@example.com",
    "full_name": "æ–°ç”¨æˆ·",
    "password": "password123"
  }'
```

### ç”¨æˆ·ç™»å½•

```bash
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123456"
  }'
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "token_type": "bearer",
  "expires_in": 1800,
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "username": "admin",
    "email": "admin@pancrepal.com",
    "role": "admin",
    "status": "active"
  }
}
```

### ä½¿ç”¨è®¤è¯ä»¤ç‰Œ

```bash
curl -X GET "http://localhost:8000/api/v1/auth/me" \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
```

## æƒé™çº§åˆ«

### ğŸ”“ å…¬å¼€ç«¯ç‚¹
- `POST /api/v1/auth/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/v1/auth/login` - ç”¨æˆ·ç™»å½•
- `GET /health` - å¥åº·æ£€æŸ¥

### ğŸ” éœ€è¦è®¤è¯çš„ç«¯ç‚¹
- `GET /api/v1/auth/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `PUT /api/v1/auth/me` - æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
- `POST /api/v1/auth/change-password` - ä¿®æ”¹å¯†ç 

### ğŸ‘‘ ç®¡ç†å‘˜ä¸“ç”¨ç«¯ç‚¹
- `GET /api/v1/auth/users` - è·å–ç”¨æˆ·åˆ—è¡¨
- `GET /api/v1/auth/users/{user_id}` - è·å–æŒ‡å®šç”¨æˆ·ä¿¡æ¯
- `PUT /api/v1/auth/users/{user_id}` - æ›´æ–°æŒ‡å®šç”¨æˆ·ä¿¡æ¯
- `DELETE /api/v1/auth/users/{user_id}` - åˆ é™¤æŒ‡å®šç”¨æˆ·
- `GET /api/v1/auth/stats` - è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯

## æ•°æ®åº“ç»“æ„

### ç”¨æˆ·é›†åˆ (users)

```json
{
  "_id": "ObjectId",
  "username": "string (å”¯ä¸€)",
  "email": "string (å”¯ä¸€)",
  "full_name": "string",
  "role": "admin|premium|user",
  "status": "active|inactive|suspended",
  "hashed_password": "string",
  "created_at": "datetime",
  "updated_at": "datetime",
  "last_login": "datetime",
  "api_calls_count": "number",
  "max_api_calls": "number"
}
```

### ç´¢å¼•
- `username` - å”¯ä¸€ç´¢å¼•
- `email` - å”¯ä¸€ç´¢å¼•
- `role` - æ™®é€šç´¢å¼•
- `status` - æ™®é€šç´¢å¼•
- `created_at` - æ™®é€šç´¢å¼•

## å®‰å…¨ç‰¹æ€§

### ğŸ”’ å¯†ç å®‰å…¨
- ä½¿ç”¨bcryptè¿›è¡Œå¯†ç å“ˆå¸Œ
- å¯†ç å¼ºåº¦éªŒè¯ï¼ˆæœ€å°‘6ä½ï¼‰
- æ”¯æŒå¯†ç ä¿®æ”¹

### ğŸ« JWTå®‰å…¨
- ä»¤ç‰Œè¿‡æœŸæ—¶é—´ï¼š30åˆ†é’Ÿ
- ä½¿ç”¨HS256ç®—æ³•
- åŒ…å«ç”¨æˆ·è§’è‰²ä¿¡æ¯

### ğŸ›¡ï¸ è®¿é—®æ§åˆ¶
- åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
- APIè°ƒç”¨æ¬¡æ•°é™åˆ¶
- ç”¨æˆ·çŠ¶æ€éªŒè¯

## å¼€å‘æŒ‡å—

### æ·»åŠ è®¤è¯åˆ°ç°æœ‰API

```python
from auth.dependencies import get_current_active_user, get_admin_user

@app.get("/protected-endpoint")
async def protected_endpoint(current_user = Depends(get_current_active_user)):
    return {"message": f"Hello {current_user.username}!"}

@app.get("/admin-only")
async def admin_endpoint(current_user = Depends(get_admin_user)):
    return {"message": "Admin only!"}
```

### æ£€æŸ¥APIé™åˆ¶

```python
from auth.dependencies import check_api_limit, increment_api_calls

@app.post("/api-call")
async def api_call(current_user = Depends(get_current_active_user)):
    # æ£€æŸ¥APIè°ƒç”¨é™åˆ¶
    if not check_api_limit(current_user.id):
        raise HTTPException(status_code=429, detail="APIè°ƒç”¨æ¬¡æ•°è¶…é™")
    
    # å¢åŠ APIè°ƒç”¨æ¬¡æ•°
    await increment_api_calls(current_user.id)
    
    # æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    return {"message": "APIè°ƒç”¨æˆåŠŸ"}
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **MongoDBè¿æ¥å¤±è´¥**
   - æ£€æŸ¥MongoDBæœåŠ¡æ˜¯å¦è¿è¡Œ
   - éªŒè¯è¿æ¥å­—ç¬¦ä¸²æ ¼å¼
   - æ£€æŸ¥ç½‘ç»œè¿æ¥

2. **JWTä»¤ç‰Œæ— æ•ˆ**
   - æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
   - éªŒè¯ä»¤ç‰Œæ ¼å¼
   - ç¡®è®¤SECRET_KEYé…ç½®

3. **æƒé™ä¸è¶³**
   - æ£€æŸ¥ç”¨æˆ·è§’è‰²
   - éªŒè¯ç”¨æˆ·çŠ¶æ€
   - ç¡®è®¤APIç«¯ç‚¹æƒé™è¦æ±‚

### æ—¥å¿—æŸ¥çœ‹

ç³»ç»Ÿä¼šè®°å½•è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- ç”¨æˆ·è®¤è¯è¿‡ç¨‹
- æ•°æ®åº“æ“ä½œ
- é”™è¯¯å’Œå¼‚å¸¸
- APIè°ƒç”¨ç»Ÿè®¡

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### å®‰å…¨å»ºè®®

1. **æ›´æ”¹é»˜è®¤å¯†ç **
   - é¦–æ¬¡éƒ¨ç½²åç«‹å³ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
   - ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥

2. **JWTå¯†é’¥ç®¡ç†**
   - ä½¿ç”¨å¼ºéšæœºå¯†é’¥
   - å®šæœŸè½®æ¢å¯†é’¥
   - é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†

3. **ç½‘ç»œå®‰å…¨**
   - é™åˆ¶CORSæ¥æº
   - ä½¿ç”¨HTTPS
   - é…ç½®é˜²ç«å¢™è§„åˆ™

4. **æ•°æ®åº“å®‰å…¨**
   - å¯ç”¨MongoDBè®¤è¯
   - é™åˆ¶æ•°æ®åº“è®¿é—®IP
   - å®šæœŸå¤‡ä»½æ•°æ®

### æ€§èƒ½ä¼˜åŒ–

1. **æ•°æ®åº“ä¼˜åŒ–**
   - åˆ›å»ºé€‚å½“çš„ç´¢å¼•
   - ç›‘æ§æŸ¥è¯¢æ€§èƒ½
   - å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®

2. **ç¼“å­˜ç­–ç•¥**
   - å®ç°Redisç¼“å­˜
   - ç¼“å­˜ç”¨æˆ·ä¼šè¯ä¿¡æ¯
   - ç¼“å­˜é¢‘ç¹æŸ¥è¯¢ç»“æœ

## æ›´æ–°æ—¥å¿—

### v0.2.0 (å½“å‰ç‰ˆæœ¬)
- âœ… é›†æˆç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- âœ… MongoDBæ•°æ®åº“æ”¯æŒ
- âœ… JWTä»¤ç‰Œè®¤è¯
- âœ… åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
- âœ… ç”¨æˆ·ç®¡ç†API
- âœ… APIè°ƒç”¨é™åˆ¶

### v0.1.0
- âœ… åŸºç¡€æ™ºèƒ½ä½“ç³»ç»Ÿ
- âœ… å¤šAIå¹³å°æ”¯æŒ

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
2. æ£€æŸ¥APIæ–‡æ¡£
3. æäº¤Issueåˆ°é¡¹ç›®ä»“åº“

---

**æ³¨æ„**: æœ¬ç³»ç»Ÿä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¯·éµå¾ªå®‰å…¨æœ€ä½³å®è·µã€‚
